name: "Perf-Port Spack Buildcache"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  setup-buildcache:
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
        with:
          platforms: ppc64le

      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Run manylinux container
        run: |
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          docker buildx create --use
          docker pull quay.io/pypa/manylinux2014_ppc64le
          docker run --rm --platform linux/ppc64le -v $(pwd):/workspace -w /workspace quay.io/pypa/manylinux2014_ppc64le bash -c "
            echo 'SPACK_PYTHON=/opt/python/cp312-cp312/bin/python' >> \$GITHUB_ENV &&
            spack mirror add develop-2024-06-02 https://binaries.spack.io/develop-2024-06-02 &&
            spack buildcache keys --install --trust &&
            spack compiler find --mixed-toolchain &&
            spack install gmake &&
            echo \$(spack location -i gmake)/bin >> \$GITHUB_PATH &&
            spack -e . -v concretize &&
            spack -e . env depfile -o Makefile &&
            make -Orecurse -j \$(($(nproc) + 1)) SPACK_INSTALL_FLAGS=--no-check-signature &&
            spack -e . mirror set --push --oci-username \$GITHUB_ACTOR --oci-password \${{ secrets.GITHUB_TOKEN }} local-buildcache &&
            spack -e . buildcache push -j \$(($(nproc) + 1)) --base-image quay.io/pypa/manylinux2014_ppc64le --update-index --force local-buildcache
          "

